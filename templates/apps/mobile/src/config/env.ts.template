import Constants from "expo-constants";
import { Platform } from "react-native";

interface AppConfig {
  apiUrl: string;
}

/**
 * Get the appropriate localhost URL for the current platform.
 * - iOS Simulator: localhost works directly
 * - Android Emulator: needs 10.0.2.2 (Android's alias for host loopback)
 * - Physical device: needs the machine's local network IP (set via API_URL env var)
 */
function getLocalhostUrl(port: number): string {
  if (Platform.OS === "android") {
    // Android emulator uses 10.0.2.2 to reach host machine
    return `http://10.0.2.2:${port}`;
  }
  // iOS simulator and web can use localhost
  return `http://localhost:${port}`;
}

function getConfig(): AppConfig {
  const extra = Constants.expoConfig?.extra as Record<string, unknown> | undefined;

  // If API_URL is explicitly set, use it (for production/staging)
  // Otherwise, use platform-aware localhost for development
  const apiUrl = (extra?.["apiUrl"] as string) || getLocalhostUrl(3001);

  return { apiUrl };
}

export const config = getConfig();

export function getApiUrl(): string {
  return config.apiUrl;
}
